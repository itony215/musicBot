const kill = {
  '有一天': {
    title: '有一天',
    subtitle: '',
    image_url: "https://i.ytimg.com/vi/7OAkr_Flq6A/hqdefault.jpg",
    item_url: 'https://www.youtube.com/watch?v=7OAkr_Flq6A'
  },
  '解脫': {
    title: '解脫',
    subtitle: '',
    image_url: "https://i.ytimg.com/vi/fJpj-kg3eoQ/hqdefault.jpg",
    item_url: 'https://youtu.be/fJpj-kg3eoQ'
  },
  '主你永遠與我同在': {
    title: '主你永遠與我同在',
    subtitle: '',
    image_url: "https://i.ytimg.com/vi/VOQe_vx2AZE/maxresdefault.jpg",
    item_url: 'https://youtu.be/VOQe_vx2AZE'
  }
};
const cry = {
  '會呼吸的痛': {
    title: '會呼吸的痛',
    subtitle: '',
    image_url: "https://i.ytimg.com/vi/gVr_cM_d55I/hqdefault.jpg",
    item_url: 'https://www.youtube.com/watch?v=gVr_cM_d55I'
  },
  '給我一個理由忘記': {
    title: '給我一個理由忘記',
    subtitle: '',
    image_url: "https://i.ytimg.com/vi/o0qU9m4StrY/maxresdefault.jpg",
    item_url: 'https://youtu.be/F5FlN-NBGo8'
  },
  '一個人也可以幸福': {
    title: '一個人也可以幸福',
    subtitle: '',
    image_url: "https://i.ytimg.com/vi/5a-3s6f1khM/hqdefault.jpg",
    item_url: 'https://youtu.be/5a-3s6f1khM'
  }
};

const fuck = {
  '分手快樂': {
    title: '分手快樂',
    subtitle: '',
    image_url: "https://i.ytimg.com/vi/lBNYpPmjH8M/hqdefault.jpg",
    item_url: 'https://youtu.be/lBNYpPmjH8M'
  },
  '分手需要練習的': {
    title: '分手需要練習的',
    subtitle: '',
    image_url: "https://i.ytimg.com/vi/ze0ZRXsagXY/hqdefault.jpg",
    item_url: 'https://www.youtube.com/watch?v=ze0ZRXsagXY'
  },
  '我們沒有在一起': {
    title: '我們沒有在一起',
    subtitle: '',
    image_url: "https://i.ytimg.com/vi/CfYG8Q3ZpMA/hqdefault.jpg",
    item_url: 'https://www.youtube.com/watch?v=CfYG8Q3ZpMA'
  }
};

const grace = {
  '恩典之路': {
    title: '恩典之路',
    subtitle: '我的心情現在適合這首歌',
    image_url: "https://encrypted-tbn3.gstatic.com/images?q=tbn:ANd9GcTKqtJAouJ7Ys3qt2gfM_DH21_O18lWnKgbt47Ve0NtUhGUK2zh",
    item_url: 'https://www.youtube.com/watch?v=0Q444bzsehU'
  },
  '奇異恩典': {
    title: '奇異恩典',
    subtitle: '我的心情現在適合這首歌',
    image_url: "https://i.ytimg.com/vi/TZ25P0aRikw/hqdefault.jpg?custom=true&w=336&h=188&stc=true&jpg444=true&jpgq=90&sp=67&sat=0.2&sigh=H8BfzRvOzOuIiNgg6HVMXgpRdfg",
    item_url: 'https://www.youtube.com/watch?v=TZ25P0aRikw'
  },
  '進入祢愛裡': {
    title: '進入祢愛裡',
    subtitle: '',
    image_url: "https://www.testifygod.com/wp-content/uploads/2016/10/%E9%80%B2%E5%85%A5%E7%A5%A2%E6%84%9B%E8%A3%A1.jpg",
    item_url: 'https://youtu.be/jFkDCnbn92A'
  },
};
const happy = {
  'Good Time': {
    title: 'Good Time',
    subtitle: '我的心情現在適合這首歌',
    image_url: "https://i.ytimg.com/vi/0bjBf4BxaEE/maxresdefault.jpg",
    item_url: 'https://youtu.be/78x2hd4R920'
  },
  'I Love You': {
    title: 'I Love You',
    subtitle: '',
    image_url: "https://i.ytimg.com/vi/3zHmmBQu2kM/maxresdefault.jpg",
    item_url: 'https://www.youtube.com/watch?v=3zHmmBQu2kM'
  },
  '滿有能力': {
    title: '滿有能力',
    subtitle: '',
    image_url: "https://i.ytimg.com/vi/Zq5OMCsM4p8/maxresdefault.jpg",
    item_url: 'https://www.youtube.com/watch?v=Zq5OMCsM4p8'
  }
};
const depressed = {
  '我也曾那樣哭過': {
    title: '我也曾那樣哭過',
    subtitle: '我的心情現在適合這首歌',
    image_url: "https://i.ytimg.com/vi/8JYdIxwUTg8/hqdefault.jpg",
    item_url: 'https://youtu.be/8JYdIxwUTg8'
  },
  '進入祢愛裡': {
    title: '進入祢愛裡',
    subtitle: '',
    image_url: "https://www.testifygod.com/wp-content/uploads/2016/10/%E9%80%B2%E5%85%A5%E7%A5%A2%E6%84%9B%E8%A3%A1.jpg",
    item_url: 'https://youtu.be/jFkDCnbn92A'
  },
  '我不會飛': {
    title: '我不會飛',
    subtitle: '',
    image_url: "https://i.ytimg.com/vi/jy10WKMcx0g/hqdefault.jpg",
    item_url: 'https://www.youtube.com/watch?v=_AbSkV3C-Y8'
  }
};
const DATA = { '殺': kill, '開心': happy, '哭': cry, '分手': fuck, '恩典': grace, '悶':depressed };


var builder = require('botbuilder');
var restify = require('restify');
var request = require('request');
var cheerio = require('cheerio');
var server = restify.createServer();
server.listen(process.env.port || process.env.PORT || 3978, function () {
  console.log('%s listening to %s', server.name, server.url);
});
// Serve a static web page
server.get(/.*/, restify.serveStatic({
  'directory': '.',
  'default': 'index.html'
}));
var connector = new builder.ChatConnector({
  appId: process.env.MICROSOFT_APP_ID,
  appPassword: process.env.MICROSOFT_APP_PASSWORD
});
var bot = new builder.UniversalBot(connector);
server.post('/api/messages', connector.listen());

var model = 'https://westus.api.cognitive.microsoft.com/luis/v2.0/apps/01f14fbd-d409-4951-b638-080f5867ec65?subscription-key=93971faefdc84030b897dbdca188cde2&verbose=true&timezoneOffset=0.0&q=';
const YOUTUBE_API = `https://www.youtube.com/results?search_query=`;

var recognizer = new builder.LuisRecognizer(model);
var intents = new builder.IntentDialog({ recognizers: [recognizer] });
bot.dialog('/', function (session) {
  session.send("分享好音樂，想點什麼歌呢？ 或者說說現在的心情，推薦幾首好歌給您。");
  session.beginDialog('/moodMusic');
});

bot.dialog('/moodMusic', intents);

intents.matches('點歌', [
  function (session, args, next) {
    var task = builder.EntityRecognizer.findEntity(args.entities, '歌曲');
    var singer = builder.EntityRecognizer.findEntity(args.entities, '歌手');
    if (!task) {
      if (!singer) {
        builder.Prompts.text(session, "什麼歌名呢?");
      } else {
        builder.Prompts.text(session, '想聽' + singer.entity.toString() + '的什麼歌呢?');
      }  
    } else {
      if (!singer) {
        next({ response: task.entity });
      } else {
        next({ response: task.entity, response2: singer.entity });
      }
    }
  },
  function (session, results) {
    if (results.response) {
      const youtubeUrl = `${YOUTUBE_API}${encodeURIComponent(results.response)}`;
      request({ uri: youtubeUrl }, function (error, response, body) {
        const $ = cheerio.load(body);
        const href = $('.yt-lockup-title > a').attr('href');
        const youtube_title = $('.yt-lockup-title > a').attr('title');
        const img_href = $('.yt-thumb-simple > img').attr('src');
        const videoHref = `https://www.youtube.com${href}`;
        msg = new builder.Message(session);
        msg.attachments([{
          contentType: "image/jpeg",
          contentUrl: img_href
        }]);
        session.send(msg);
        session.send(`[${youtube_title}](${videoHref})`);
      });
      session.send('好喔~ "%s"的連結跟預覽圖來囉！', results.response);
    } else {
      session.send("oops!");//error handling
    }
  }
]);
let matchProp = '';

intents.matches('心情', [
  function (session) {
    if (session.message.text) {
      let isMatch = false;
      Object.keys(DATA).forEach((prop) => {
        if (isMatch) {
          return;
        }
        isMatch = session.message.text.indexOf(prop) >= 0;
        if (isMatch) {
          matchProp = prop;
        } else {
          matchProp = '恩典';
        }
      })
      builder.Prompts.choice(session, "我能理解你的心情，推薦三首好歌給您選擇唷！", DATA[matchProp]);
    } else {
      session.send("Ok");
    }
  },
  function (session, results) {

    if (results.response) {
      var mood = DATA[matchProp][results.response.entity];
      msg = new builder.Message(session);
      msg.sourceEvent({
        facebook: {
          attachment: {
            type: "template",
            payload: {
              template_type: "generic",
              elements: [{
                title: mood.title,
                subtitle: mood.subtitle,
                image_url: mood.image_url,
                item_url: mood.item_url,
                buttons: [{
                  type: "element_share"
                }]
              }]
            }
          }
        }
      });
      if (session.message.source == 'facebook') {
        session.send(msg);
      } else {
        msg.attachments([{
          contentType: "image/jpeg",
          contentUrl: mood.image_url
        }]);
        session.send(msg);
        session.send("%(item_url)s", mood);
        session.send('你的心情現在適合這首歌');
      }

    } else {
      session.send("ok");
    }
  }

]);

intents.onDefault(builder.DialogAction.send("對不起，我不太能理解您的意思，您可以再說說現在心情或者點歌唷！"));